[TOC]

### 领域驱动笔记

> [实现领域驱动] vaughn vernon

#### 1.领域概念

对于业务的解决方案，通常采用抽象，分治，知识。

领域包含问题域和解空间:

- 问题域可细分为核心域，通用域，支撑域。由领域专家，开发者，测试等人员共同参与**通用语言**的制定，用于描述问题域。

- 解空间不同的**限界上下文**组成，通过**上下文映射图**表示各上下文之间的关系，一个限界上下文指一个解决方案，包含一个子域。

限界上下文：用于封装通用语言和领域对象，标定了业务服务系统的边界。包含领域服务，领域事件，实体，值对象，聚合根，资源库。可以通过门面模式与其他上下文交互。

限界上下文之间交互: 通过开放主机模式，比如REST，RPC接口，但ddd推荐上游使用异步通知来达到服务自治.p92

#### 2.架构

一个上下文对应一个领域架构，包括接口层，应用层，领域层p116

领域架构方案如下:

(1) 分层架构

(2) DIP依赖翻转架构

(3) 六边形架构

- 支持http,RPC, mq等上游端口模式，或者下游资源库依赖关系型，文档型，内存型等组件

(4) SOA面向服务架构

- 业务价值高于技术策略p116
- 战略目标高于项目利益

(5) 事件驱动架构

- 串行化处理，以管道流执行

(6)长时处理架构

- 串行化+并行化处理，事件开始及结尾成环状

(7)事件源架构

- 快照+日志重放

#### 3.实体，值对象

领域对象包含实体，值对象，聚合根。

(1)实体具有唯一标识和可变性,实体唯一标识生成方式: 

- 用户填写
- uuid
- 持久化生成(mysql,redis)

> **通用语言**提供了设计领域模型时的概念术语。根据通用语言分析实体概念时，要避免技术和战术化，从战略层面进行分析。p168

(2 )值对象是稳定的，所以值对象可以存放实体的唯一标识p151

值对象的特征:

- 度量或描述
- 不变性
- 整体概念
- 可替换、值对象相等、无副作用行为

使用值对象进行最小化集成，定义基础值对象，让继承值对象直接使用 p206

- 如*Collaborator* 

使用值对象表示标准类型，定义描述或枚举，让其成为标准对象 p207

- 如*GroupMemberType* 

拒绝由数据建模泄露带来的不利影响，根据领域模型来设计数据模型，不应颠倒p221

所以应从领域模型的角度，考虑使用实体或者**值对象(建议)**来表述数据库中的数据

#### 4.领域服务

>业务中这样一种场景：实体和值对象有各自的职责，但某些操作过程并不是实体或者值对象的行为时，那最佳位置在哪儿?

领域服务和通用语言是一致的，并且是无状态的。p237

过渡的使用领域服务，会导致**贫血领域模型**，即所有的业务逻辑都位于领域服务中，而不是实体或者值对象。

领域服务可根据实际情况，无需预先定义独立接口，语义化的实现具体服务即可。

#### 5.领域事件

(1) 领域事件的发布及订阅:

- 订阅: 实施者一般为**应用服务**，或者领域服务。订阅逻辑中的事务原子性可通过调用**应用服务**实现p262
- 发布: 实施者为聚合，实体内的状态变更，而事件发布工具并没有领域的概念。p265

(2) 向远程限界上下文发送领域事件的特征:

- 确保消息一致性
- 可自治
- 存在延时性

(3) 转发储存风格架构

- REST: 是一种拉取风格。领域模型中产生事件，由客户端进行拉取。服务端，客户端可以适当进行缓存策略。客户端自身按需进行序列判断、过滤等。参考promethues监控打点
- MQ: 是一种推送风格。MQ组件保证消息的有序性。

#### 6.聚合

(1) 设计小聚合，并通过唯一标识引用其他聚合 p322

(2) 在聚合内部可以使用**领域事件** p327

(3) 原则上单事务修改单个聚合实例，但是可以打破规则，单事务修改多个聚合实例。 p331 





#### 编码参考

```
  application
  	application.eventStore #应用组件 p288
  domain
  	domain.model #领域模型
  	domain.model.aggregate聚合根 p316
  infrastructure
  	infrastructure.services # p242
  	infrastructure.repository
  	infrastructure.component
  lib
  	lib.logger
```

  

  